# pages/page_library_prompts.py

import streamlit as st
import sqlite3
import pandas as pd
from utils.db import get_connection
from utils.generator import generate_prompts

def init_prompts_table(conn: sqlite3.Connection):
    """–°–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—É library_prompts, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç."""
    conn.execute("""
        CREATE TABLE IF NOT EXISTS library_prompts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            description TEXT NOT NULL,
            prompt TEXT NOT NULL
        );
    """)
    conn.commit()

def populate_initial_prompts(conn: sqlite3.Connection):
    """
    –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç—å –µ—ë –±–∞–∑–æ–≤—ã–º–∏ –ø—Ä–æ–º–ø—Ç–∞–º–∏
    –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏ generate_prompts().
    """
    cur = conn.cursor()
    cur.execute("SELECT COUNT(1) FROM library_prompts;")
    if cur.fetchone()[0] == 0:
        records = generate_prompts()
        cur.executemany(
            "INSERT INTO library_prompts (description, prompt) VALUES (?, ?);",
            records
        )
        conn.commit()

def fetch_prompts(conn: sqlite3.Connection) -> pd.DataFrame:
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–º–ø—Ç—ã –∏–∑ –ë–î."""
    return pd.read_sql_query(
        "SELECT id, description, prompt FROM library_prompts ORDER BY id;",
        conn
    )

def update_prompt(conn: sqlite3.Connection, prompt_id: int, desc: str, text: str):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –ø—Ä–æ–º–ø—Ç–∞ –≤ –ë–î."""
    conn.execute(
        "UPDATE library_prompts SET description = ?, prompt = ? WHERE id = ?;",
        (desc, text, prompt_id)
    )
    conn.commit()

def delete_prompt(conn: sqlite3.Connection, prompt_id: int):
    """–£–¥–∞–ª—è–µ—Ç –ø—Ä–æ–º–ø—Ç –∏–∑ –ë–î."""
    conn.execute(
        "DELETE FROM library_prompts WHERE id = ?;",
        (prompt_id,)
    )
    conn.commit()

def main():
    # –ö–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –∑–∞—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–Ω–æ–≤–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    conn = get_connection()
    init_prompts_table(conn)
    populate_initial_prompts(conn)
    df = fetch_prompts(conn)

    st.title("üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤")
    st.markdown("–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π –ø—Ä–æ–º–ø—Ç, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –µ–≥–æ –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å.")

    if df.empty:
        st.info("–í –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –ø—Ä–æ–º–ø—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.")
        return

    # –î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏ —Å–æ–∑–¥–∞—ë–º expander —Å –ø–æ–ª—è–º–∏ –∏ –∫–Ω–æ–ø–∫–∞–º–∏
    for row in df.itertuples(index=False):
        with st.expander(f"#{row.id} ‚Äî {row.description}", expanded=False):
            # –ü–æ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            new_desc = st.text_input(
                label="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ",
                value=row.description,
                key=f"desc_{row.id}"
            )
            new_text = st.text_area(
                label="–ü—Ä–æ–º–ø—Ç",
                value=row.prompt,
                key=f"text_{row.id}",
                height=150
            )

            col1, col2 = st.columns(2)
            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–æ–∫
            with col1:
                if st.button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", key=f"save_{row.id}"):
                    update_prompt(conn, row.id, new_desc, new_text)
                    st.success(f"–ü—Ä–æ–º–ø—Ç #{row.id} –æ–±–Ω–æ–≤–ª—ë–Ω")
                    st.experimental_rerun()
            # –£–¥–∞–ª–µ–Ω–∏–µ
            with col2:
                if st.button("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å", key=f"del_{row.id}"):
                    delete_prompt(conn, row.id)
                    st.success(f"–ü—Ä–æ–º–ø—Ç #{row.id} —É–¥–∞–ª—ë–Ω")
                    st.experimental_rerun()

if __name__ == "__main__":
    main()
